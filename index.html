<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- å®‰å…¨å¤´éƒ¨ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>ç™»å½• - TèŠå®¤</title>
    <style>
        :root {
            --primary-blue: #1890ff;
            --primary-dark: #096dd9;
            --primary-light: #69c0ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #262626;
            --text-secondary: #595959;
            --border-color: #d9d9d9;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }

        .logo h1 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
        }

        .form-input.error {
            border-color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .divider {
            text-align: center;
            margin: 24px 0;
            position: relative;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            background: var(--card-bg);
            padding: 0 16px;
            position: relative;
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
        }

        .register-link a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .register-link a:hover {
            color: var(--primary-dark);
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 90%;
            word-wrap: break-word;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--error-color);
        }

        .attempts-warning {
            color: var(--warning-color);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .attempts-warning.show {
            display: block;
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 24px;
                margin: 0 16px;
            }
            
            .logo-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            
            .logo h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <div class="logo-icon">ğŸ’¬</div>
            <h1>TèŠå®¤</h1>
            <p>å¯é  å®‰å…¨ ç•…èŠ</p>
        </div>
        
        <form id="login-form" autocomplete="on" novalidate>
            <div class="form-group">
                <label class="form-label" for="username">ç”¨æˆ·å</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="username" 
                    name="username"
                    placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
                    required
                    autocomplete="username"
                    maxlength="50"
                    pattern="[a-zA-Z0-9_\u4e00-\u9fa5]+"
                    title="ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡"
                >
                <div class="error-message" id="username-error">ç”¨æˆ·åä¸èƒ½ä¸ºç©º</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">å¯†ç </label>
                <input 
                    type="password" 
                    class="form-input" 
                    id="password" 
                    name="password"
                    placeholder="è¯·è¾“å…¥å¯†ç " 
                    required
                    autocomplete="current-password"
                    maxlength="100"
                    minlength="6"
                >
                <div class="error-message" id="password-error">å¯†ç ä¸èƒ½ä¸ºç©º</div>
            </div>
            
            <button type="submit" class="login-btn" id="login-btn">
                <span id="btn-text">ç™»å½•</span>
            </button>
            
            <div class="attempts-warning" id="attempts-warning"></div>
        </form>
        
        <div class="divider">
            <span>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
        </div>
        
        <div class="register-link">
            <a href="register.html">ç«‹å³æ³¨å†Œ</a>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
        (function() {
            'use strict';
            
            // å®‰å…¨é…ç½®
            const SECURITY_CONFIG = {
                MAX_LOGIN_ATTEMPTS: 5,
                LOCKOUT_DURATION: 3 * 60 * 1000, // 3åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
                USERNAME_MAX_LENGTH: 50,
                PASSWORD_MAX_LENGTH: 100,
                PASSWORD_MIN_LENGTH: 6
            };

            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const btnText = document.getElementById('btn-text');
            const toast = document.getElementById('toast');
            const attemptsWarning = document.getElementById('attempts-warning');

            // è¾“å…¥æ¸…ç†å‡½æ•° - é˜²æ­¢XSS
            function sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input.trim()
                    .replace(/[<>]/g, '') // ç§»é™¤æ½œåœ¨çš„HTMLæ ‡ç­¾å­—ç¬¦
                    .replace(/javascript:/gi, '') // ç§»é™¤javascript:åè®®
                    .replace(/on\w+=/gi, ''); // ç§»é™¤äº‹ä»¶å¤„ç†å™¨
            }

            // éªŒè¯ç”¨æˆ·åæ ¼å¼
            function validateUsername(username) {
                const cleaned = sanitizeInput(username);
                if (!cleaned) {
                    return { valid: false, message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' };
                }
                if (cleaned.length > SECURITY_CONFIG.USERNAME_MAX_LENGTH) {
                    return { valid: false, message: `ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡${SECURITY_CONFIG.USERNAME_MAX_LENGTH}ä¸ªå­—ç¬¦` };
                }
                // å…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡
                const usernamePattern = /^[a-zA-Z0-9_\u4e00-\u9fa5]+$/;
                if (!usernamePattern.test(cleaned)) {
                    return { valid: false, message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡' };
                }
                return { valid: true, value: cleaned };
            }

            // éªŒè¯å¯†ç æ ¼å¼
            function validatePassword(password) {
                if (!password || password.length === 0) {
                    return { valid: false, message: 'å¯†ç ä¸èƒ½ä¸ºç©º' };
                }
                if (password.length < SECURITY_CONFIG.PASSWORD_MIN_LENGTH) {
                    return { valid: false, message: `å¯†ç é•¿åº¦è‡³å°‘ä¸º${SECURITY_CONFIG.PASSWORD_MIN_LENGTH}ä½` };
                }
                if (password.length > SECURITY_CONFIG.PASSWORD_MAX_LENGTH) {
                    return { valid: false, message: `å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡${SECURITY_CONFIG.PASSWORD_MAX_LENGTH}ä¸ªå­—ç¬¦` };
                }
                return { valid: true, value: password };
            }

            // è·å–ç™»å½•å°è¯•è®°å½•
            function getLoginAttempts() {
                try {
                    const attempts = localStorage.getItem('loginAttempts');
                    return attempts ? JSON.parse(attempts) : { count: 0, lockoutUntil: null };
                } catch (e) {
                    return { count: 0, lockoutUntil: null };
                }
            }

            // ä¿å­˜ç™»å½•å°è¯•è®°å½•
            function saveLoginAttempts(attempts) {
                try {
                    localStorage.setItem('loginAttempts', JSON.stringify(attempts));
                } catch (e) {
                    console.error('ä¿å­˜ç™»å½•å°è¯•è®°å½•å¤±è´¥:', e);
                }
            }

            // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
            function checkLockout() {
                const attempts = getLoginAttempts();
                if (attempts.lockoutUntil && Date.now() < attempts.lockoutUntil) {
                    const remainingMs = attempts.lockoutUntil - Date.now();
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    const remainingMinutes = Math.ceil(remainingMs / 60000);
                    
                    // å¦‚æœå‰©ä½™æ—¶é—´å°‘äº1åˆ†é’Ÿï¼Œæ˜¾ç¤ºç§’æ•°ï¼›å¦åˆ™æ˜¾ç¤ºåˆ†é’Ÿæ•°
                    let timeMessage;
                    if (remainingSeconds < 60) {
                        timeMessage = `${remainingSeconds}ç§’`;
                    } else {
                        timeMessage = `${remainingMinutes}åˆ†é’Ÿ`;
                    }
                    
                    return {
                        locked: true,
                        message: `ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·${timeMessage}åå†è¯•`
                    };
                }
                // å¦‚æœé”å®šæ—¶é—´å·²è¿‡ï¼Œé‡ç½®è®¡æ•°
                if (attempts.lockoutUntil && Date.now() >= attempts.lockoutUntil) {
                    saveLoginAttempts({ count: 0, lockoutUntil: null });
                }
                return { locked: false };
            }

            // å¢åŠ ç™»å½•å°è¯•æ¬¡æ•°
            function incrementLoginAttempts() {
                const attempts = getLoginAttempts();
                attempts.count += 1;
                
                if (attempts.count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
                    attempts.lockoutUntil = Date.now() + SECURITY_CONFIG.LOCKOUT_DURATION;
                    showToast('ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·3åˆ†é’Ÿåå†è¯•', 'error');
                } else {
                    const remaining = SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS - attempts.count;
                    attemptsWarning.textContent = `è¿˜æœ‰ ${remaining} æ¬¡å°è¯•æœºä¼š`;
                    attemptsWarning.classList.add('show');
                }
                
                saveLoginAttempts(attempts);
            }

            // é‡ç½®ç™»å½•å°è¯•æ¬¡æ•°
            function resetLoginAttempts() {
                saveLoginAttempts({ count: 0, lockoutUntil: null });
                attemptsWarning.classList.remove('show');
            }

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            function showToast(message, type = 'error') {
                // é˜²æ­¢XSS - è½¬ä¹‰HTML
                const textNode = document.createTextNode(message);
                toast.textContent = '';
                toast.appendChild(textNode);
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // è¡¨å•éªŒè¯
            function validateForm() {
                let isValid = true;
                
                // éªŒè¯ç”¨æˆ·å
                const usernameValidation = validateUsername(usernameInput.value);
                if (!usernameValidation.valid) {
                    document.getElementById('username-error').textContent = usernameValidation.message;
                    document.getElementById('username-error').classList.add('show');
                    usernameInput.classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('username-error').classList.remove('show');
                    usernameInput.classList.remove('error');
                }
                
                // éªŒè¯å¯†ç 
                const passwordValidation = validatePassword(passwordInput.value);
                if (!passwordValidation.valid) {
                    document.getElementById('password-error').textContent = passwordValidation.message;
                    document.getElementById('password-error').classList.add('show');
                    passwordInput.classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('password-error').classList.remove('show');
                    passwordInput.classList.remove('error');
                }
                
                return isValid;
            }

            // å¤„ç†ç™»å½•
            async function handleLogin(event) {
                event.preventDefault();
                
                // æ£€æŸ¥é”å®šçŠ¶æ€
                const lockoutCheck = checkLockout();
                if (lockoutCheck.locked) {
                    showToast(lockoutCheck.message, 'error');
                    loginBtn.disabled = true;
                    setTimeout(() => {
                        loginBtn.disabled = false;
                    }, 1000);
                    return;
                }
                
                if (!validateForm()) {
                    return;
                }
                
                try {
                    loginBtn.disabled = true;
                    btnText.textContent = 'ç™»å½•ä¸­...';
                    
                    // æ¸…ç†å’ŒéªŒè¯è¾“å…¥
                    const usernameValidation = validateUsername(usernameInput.value);
                    const passwordValidation = validatePassword(passwordInput.value);
                    
                    if (!usernameValidation.valid || !passwordValidation.valid) {
                        showToast('è¾“å…¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹');
                        loginBtn.disabled = false;
                        btnText.textContent = 'ç™»å½•';
                        return;
                    }
                    
                    const response = await fetch('login.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: usernameValidation.value,
                            password: passwordValidation.value
                        }),
                        credentials: 'same-origin' // åªå‘é€åŒæºcookie
                    });
                    
                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // ç™»å½•æˆåŠŸï¼Œé‡ç½®å°è¯•æ¬¡æ•°
                        resetLoginAttempts();
                        showToast('ç™»å½•æˆåŠŸ', 'success');
                        
                        // å®‰å…¨åœ°ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
                        try {
                            localStorage.setItem('currentUser', usernameValidation.value);
                            if (data.token) {
                                localStorage.setItem('userToken', data.token);
                            }
                            localStorage.setItem('nick', usernameValidation.value); // å…¼å®¹åŸæœ‰èŠå¤©å®¤ç³»ç»Ÿ
                        } catch (e) {
                            console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                        }
                        
                        // è·³è½¬åˆ°èŠå¤©é¡µé¢
                        setTimeout(() => {
                            window.location.href = 'chat.html';
                        }, 1000);
                    } else {
                        // ç™»å½•å¤±è´¥ï¼Œå¢åŠ å°è¯•æ¬¡æ•°
                        incrementLoginAttempts();
                        // ä¸æ³„éœ²å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢ç”¨æˆ·åæšä¸¾æ”»å‡»
                        showToast(data.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    // ä¸å‘ç”¨æˆ·æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    incrementLoginAttempts();
                } finally {
                    loginBtn.disabled = false;
                    btnText.textContent = 'ç™»å½•';
                }
            }

            // äº‹ä»¶ç›‘å¬
            loginForm.addEventListener('submit', handleLogin);
            
            // è¾“å…¥æ—¶å®æ—¶éªŒè¯ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
            let validationTimeout;
            function debounceValidation() {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(() => {
                    validateForm();
                }, 300);
            }
            
            usernameInput.addEventListener('input', debounceValidation);
            passwordInput.addEventListener('input', debounceValidation);
            
            // é˜²æ­¢è¡¨å•è‡ªåŠ¨å¡«å……æ•æ„Ÿä¿¡æ¯ï¼ˆé¢å¤–çš„å®‰å…¨æªæ–½ï¼‰
            usernameInput.addEventListener('paste', function(e) {
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const sanitized = sanitizeInput(pastedText);
                if (sanitized !== pastedText) {
                    e.preventDefault();
                    this.value = sanitized;
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            try {
                if (localStorage.getItem('currentUser')) {
                    window.location.href = 'chat.html';
                }
            } catch (e) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', e);
            }
            
            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥é”å®šçŠ¶æ€
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    const lockoutCheck = checkLockout();
                    if (lockoutCheck.locked) {
                        loginBtn.disabled = true;
                        showToast(lockoutCheck.message, 'error');
                    } else {
                        loginBtn.disabled = false;
                    }
                }
            });
        })();
    </script>
</body>
</html>